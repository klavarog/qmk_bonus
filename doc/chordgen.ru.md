# chordgen

`chordgen` (chord generator) — программа, которая генерирует код для обработки
аккордов в QMK, который затем нужно добавить в свою программу.

## Предварительная настройка

В терминологии QMK аккорды называются `combos`, но в QMK Bonus используется
`chord`. Сначала надо включить поддержку аккордов в QMK в файле `rules.mk`:

```make
COMBO_ENABLE=yes
```

Также в файле `config.h` надо указать количество используемых аккордов.
`chordgen` может помочь их посчитать, если вызвать её так:

```bash
ruby chordgen.rb --count-chords
```

Вывод этой команды (ну или собственноручный расчёт) надо вставить в `config.h`:

```c
#define COMBO_COUNT 1 // любое число
```

Также можно настроить время, в течение которого нужно нажать клавиши аккорда. По
умолчанию оно равно `TAPPING_TERM`, и это можно не менять, но если хочется, то
делается это в том же `config.h`:

```c
#define COMBO_TERM 300 // любое число, в разумных пределах
```

Если планируется использовать русские буквы, то надо добавить в свой проект
другую библиотеку QMK Bonus — `rusmap.h`. Узнать подробнее можно в
[документации к библиотеке](./rusmap.h.ru.md).

## Формат конфигурации

Для конфигурации используется формат INI, широко применяемый на Windows. Файл
конфигурации называется `chords.ini` и находится в той же директории, что и
программа `chordgen`, но это можно настроить (подробнее в одной из последних
секций документа).

Этот файл должен выглядеть примерно так:

```ini
[LATIN]
q=rf
```

Здесь `[LATIN]` начинает секцию аккордов, которые работают, только когда активен
слой `LATIN`. Строка `q=rf` значит, что в компьютер будет отправлен сканкод
`KC_Q`, когда пользователь нажимает одновременно `KC_R` и `KC_F`.

## Использование нескольких слоёв

Это особенно нужно, если реализуются аккорды с буквами нескольких языков.

```ini
[CYRILLIC]
ф=рь

[LATIN]
q=rf
```

Такой конфиг значит, что введётся буква Ф, если нажаты Р и Ь, и текущий слой
`CYRILLIC`. Если этот слой неактивен, будут проверяться следующие секции, и так
до последней.

## Исполнение аккорда на любом слою

Аккорды, которые будут исполнятся независимо от слоя нужно вставить в секцию
`[any]`:

```ini
[any]
1=qw
```

## Исполнение произвольного кода в аккордах

Если нужно, чтобы при нажатии аккорда отправлялся не просто сканкод, а
исполнялся произвольный код, то нужно этот код обернуть в скобки и вот так:

```ini
[any]
(if (1 == 1) short_circuit();)=qw
```

Внутри скобок нельзя оставлять другие незакрытые скобки:

```ini
// Плохо!
[any]
(if (1 == 1 short_circuit();)=qw
```

## Переопределение набора символов

По умолчанию `chordgen` поддерживает только первые и вторые слои стандартных
раскладок ЙЦУКЕН и QWERTY, за исключением скобок. Если хочется, можно
переопределить существующие символы или задать свои в секции [override]:

```ini
[override]
π=KC_P
i=KC_O

[any]
π=ui
```

Получится аккорд, который срабатывает при нажатии `KC_U` и `KC_O` и отправляет
`KC_P`.

## Дополнительные опции

Эти опции нужно указать при вызове программы.

### Подсчёт аккордов

```bash
--count-chords
-c
```

Выведет количество определённых аккордов в файле конфигурации.

### Изменение расположения файла конфигурации

Если файл конфигурации расположен не в той же директории, что и `chordgen.rb`,
то нужно воспользоваться опцией `-p` или `--config-path`:

```bash
ruby chordgen.rb --config-path ~/my_chords.ini
```
